<script>
var DEFAULT_LOCALE = '/de/'
var LOCALES = [DEFAULT_LOCALE, '/en/'];
var ENG_INDEX_HREF = '/en/happening-now';
var DEU_INDEX_HREF = '/';

var NAV_ITEMS_ALWAYS_SHOW = ['blog-collection', 'events-collection']

var LOCALE_BUTTON_ID = 'language-toggle';
var LOCALE_BUTTON = '<a id="' + LOCALE_BUTTON_ID + '"></a>';
var DESKTOP_MENU_ITEM_SELECTOR = '#topNav a';
var DESKTOP_MENU_ITEM_FOLDER_SELECTOR = '.Header-nav-item--folder';
var DESKTOP_SUB_MENU_ITEM_SELECTOR = '#topNav a';
var MOBILE_MENU_ITEM_SELECTOR = '.Mobile-overlay-nav-item';
var PRIMARY_NAV_SELECTOR = '#topNav';
var PAGE_TITLE_SELECTOR = '#lower-logo a'

var WOLF_NODES = {
    getPrimaryNav: function () {
        return document.querySelector(PRIMARY_NAV_SELECTOR);
    },

    getNodes: function (selector) {
        return Array.from(document.querySelectorAll(selector));
    },

    getMobileMenuItems: function () {
        return this.getNodes(MOBILE_MENU_ITEM_SELECTOR);
    },

    getDesktopMenuFolderItems: function () {
        return this.getNodes('.Header-nav-folder-title');
    },

    getDesktopMenuItems: function () {
        return this.getNodes('#topNav li');
    },

    getDesktopSubMenuItems: function () {
        return this.getNodes(DESKTOP_SUB_MENU_ITEM_SELECTOR);
    },

    getLocaleButton: function () {

        return document.getElementById(LOCALE_BUTTON_ID);
    },

    getPageTitle: function () {
        return document.querySelector(PAGE_TITLE_SELECTOR);
    }
};

var WOLF_LOCALIZE_VIEWS = {

    showOrHideNode: function (menuItem, show) {
        if (menuItem) menuItem.style.display = show ? 'inline-block' : 'none';
    },

    updateTitleHREF: function (href) {
        WOLF_NODES.getPageTitle().href = href
    },

    renderLocaleButton: function(innerText, href) {
        var el = WOLF_NODES.getLocaleButton();
        if (!el) document.body.insertAdjacentHTML('afterbegin', LOCALE_BUTTON);
        el = WOLF_NODES.getLocaleButton();
        el.innerText = innerText;
        el.href = href;
    }
};

var WOLF_MENU_VIEWS = {
    removeLinksFromMenuItems: function () {
        WOLF_NODES.getDesktopMenuFolderItems()
        .forEach(function (item) {
            console.log(item)
            item.removeAttribute('href')
        })
    }
};

var WOLF_LOCALIZE_ACTIONS = {

    getLocale: function () {
        return document.location.pathname.substring(0, 4);
    },

    stripOriginFromPath: function (path) {
        return path.replace(document.location.origin, '');
    },

    doesLocaleExist: function () {
        const localeExists = LOCALES.some((item) => item === this.getLocale());
        return localeExists;
    },

    doesHREFBelongToLocale: function (href) {
        const locale = this.doesLocaleExist() ? this.getLocale() : DEFAULT_LOCALE;
        return this.stripOriginFromPath(href)
            .indexOf(locale) === 0;
    },

    localizeSingleDesktopMenuItem: function (item) {
        var aTag = item.querySelector("a")
        var hrefBelongsToLocale = this.doesHREFBelongToLocale(aTag.href);
        var isThisAnException = NAV_ITEMS_ALWAYS_SHOW.indexOf(item.className) !== -1
        var shouldShow = hrefBelongsToLocale || isThisAnException
        return WOLF_LOCALIZE_VIEWS.showOrHideNode(item, shouldShow);
    },

    localizeDesktopMenu: function () {
        var self = this;
        console.log(WOLF_NODES.getDesktopMenuItems())
        WOLF_NODES.getDesktopMenuItems()
        .forEach(function(item) {
            var isFolder = item.className.indexOf('folder') > -1
            console.log(item)
            if (!isFolder) return self.localizeSingleDesktopMenuItem(item)
            // var shouldShow = Array
            //     .from(item.querySelectorAll('a'))
            //     .some(function(subItem) {
            //         console.log(su'b)
            //         return self.doesHREFBelongToLocale(subItem.href)
            //     })

            // console.log(shouldShow)

            // return WOLF_LOCALIZE_VIEWS.showOrHideNode(item, shouldShow);
        });
    },

    localizeMobileMenu: function () {
        var self = this;
        WOLF_NODES.getMobileMenuItems().map(function (menuItem) {
            if (menuItem.href && self.doesHREFBelongToLocale(menuItem.href)) {
                return WOLF_LOCALIZE_VIEWS.showOrHideNode(menuItem, true);
            }
            var folderHREF = menuItem.getAttribute('data-controller-folder-toggle');
            var folderBelongs = self.doesHREFBelongToLocale('/' + folderHREF);
            return WOLF_LOCALIZE_VIEWS.showOrHideNode(menuItem, folderBelongs);
        });
    },

    currentLocaleIsGerman: function () {
        return this.getLocale() === '/de/' || this.getLocale() === '/';
    },

    getLocaleButtonText: function () {
        return this.currentLocaleIsGerman() ? 'English' : 'Deutsch' ;
    },

    getLocaleButtonHREF: function () {
        var menuHREFs = WOLF_NODES.getDesktopSubMenuItems()
        .map(function (menuItem) {
            return WOLF_LOCALIZE_ACTIONS.stripOriginFromPath(menuItem.href);
        });

        var halvingIndex = menuHREFs.length / 2;
        var pathnameIndex = menuHREFs.indexOf(window.location.pathname);

        if (pathnameIndex === -1) {
            return this.currentLocaleIsGerman() ? ENG_INDEX_HREF : DEU_INDEX_HREF;
        }

        var indexOfPageInOtherLocale = pathnameIndex > halvingIndex ?
            pathnameIndex - halvingIndex :
            pathnameIndex + halvingIndex;

        return menuHREFs[indexOfPageInOtherLocale];
    },

    localizeLocaleButton: function () {
        var text = this.getLocaleButtonText();
        var href = this.getLocaleButtonHREF();
        return WOLF_LOCALIZE_VIEWS.renderLocaleButton(text, href);
    },

    localizeTitleHREF: function() {
        const href = this.currentLocaleIsGerman() ? DEU_INDEX_HREF : ENG_INDEX_HREF;
        WOLF_LOCALIZE_VIEWS.updateTitleHREF(href);
    },

    localizeSite: function () {
        this.localizeDesktopMenu();
        this.localizeMobileMenu();
        this.localizeLocaleButton();
        this.localizeTitleHREF();
    },

    initialize: function () {
        this.localizeSite();
    }
};

var WOLF_APP = {
    initialize: function () {
        this.bindToNavChanges();
        this.onSiteChange();
    },

    onSiteChange: function () {
        WOLF_LOCALIZE_ACTIONS.initialize();
        WOLF_MENU_VIEWS.removeLinksFromMenuItems();
    },

    bindToNavChanges: function () {
        var observer = new MutationObserver(this.onSiteChange.bind(this));
        console.log(WOLF_NODES.getPrimaryNav())
        observer.observe(WOLF_NODES.getPrimaryNav(), {
            attributes: true, childList: true, characterData: true
        });
    }
};

WOLF_APP.initialize();
</script>
